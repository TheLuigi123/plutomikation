    <script>
        // --- DOM Elemente ---
        const gameArea = document.getElementById('game-area');
        const hero = document.getElementById('hero');
        const inventoryDisplay = document.getElementById('inventory');
        const quizModal = document.getElementById('quiz-modal');
        const quizTitle = document.getElementById('quiz-title');
        const quizQuestion = document.getElementById('quiz-question');
        const quizInputDisplay = document.getElementById('quiz-input-display');
        const quizMessage = document.getElementById('quiz-message');
        const numpadContainer = document.getElementById('numpad-container');
        const enemyElement = document.getElementById('enemy');
        const endScreen = document.getElementById('end-screen');
        const finalTimeDisplay = document.getElementById('final-time');
        const fastestTimesList = document.getElementById('fastest-times-list');
        const wrongAnswersList = document.getElementById('wrong-answers-list');
        const playAgainButton = document.getElementById('play-again-button');

        // --- Audio Context & Sounds ---
        let audioCtx; let levelUpSound;
        const levelUpSoundBase64 = 'data:audio/mpeg;base64,SUQzBAAAAAABEVRYWFgAAAAtAAADY29tbWVudABCaWdTb3VuZEJhbmsuY29tIC8gTGliAvUMAAAAEAAAAAAAAAAAAAAAAAAAAAAA//MkxAAAANIAAAAAExBTUUzLjk4LjIAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA';
        function initAudio() { if(!audioCtx){try{audioCtx=new(window.AudioContext||window.webkitAudioContext)();levelUpSound=new Audio(levelUpSoundBase64);levelUpSound.preload='auto';console.log("AudioContext initialized.");}catch(e){console.error("Web Audio API is not supported or initialization failed.",e);}}}
        function playTone(f=440,d=0.1,t='sine',v=0.5){if(!audioCtx)return;try{const o=audioCtx.createOscillator();const g=audioCtx.createGain();o.type=t;o.frequency.setValueAtTime(f,audioCtx.currentTime);g.gain.setValueAtTime(v,audioCtx.currentTime);g.gain.exponentialRampToValueAtTime(0.001,audioCtx.currentTime+d);o.connect(g);g.connect(audioCtx.destination);o.start(audioCtx.currentTime);o.stop(audioCtx.currentTime+d+0.05);}catch(e){console.error("Error playing tone:",e);}}
        function playClickSound(){playTone(880,0.05,'triangle',0.3);}
        function playInteractSound(){playTone(660,0.08,'sine',0.4);}
        function playCorrectSound(){playTone(523.25,0.1,'sine',0.5);setTimeout(()=>playTone(659.25,0.15,'sine',0.5),100);}
        function playWrongSound(){playTone(349.23,0.15,'square',0.4);setTimeout(()=>playTone(261.63,0.2,'square',0.4),150);}
        function playCollectSound(){playTone(783.99,0.08,'triangle',0.6);setTimeout(()=>playTone(1046.50,0.08,'triangle',0.6),80);setTimeout(()=>playTone(1318.51,0.1,'triangle',0.6),160);}
        function playFreezeSound(){playTone(440,0.3,'sawtooth',0.4);}
        function playUnfreezeSound(){playTone(587.33,0.2,'sine',0.4);}
        function playEnemySpawnSound(){playTone(110,0.3,'sawtooth',0.5);}
        function playEnemyHitSound(){playTone(220,0.2,'square',0.6);}
        function playLevelUpJingle(){if(levelUpSound&&audioCtx){levelUpSound.play().catch(e=>console.error("Error playing level up sound:",e));}else{playTone(523,0.1);setTimeout(()=>playTone(783,0.1),100);setTimeout(()=>playTone(1046,0.2),200);}}
        function playGameOverSound(){playTone(1046,0.2);setTimeout(()=>playTone(783,0.2),200);setTimeout(()=>playTone(523,0.3),400);}

        // --- Spielzustand ---
        let currentLevel = 1;
        let flowersCollected = 0;
        let flowers = [];
        let activeItem = null;
        let activeItemType = null;
        let currentQuestions = [];
        let currentQuestionIndex = 0;
        let heroIsMoving = false;
        let gameIsOver = false;
        let startTime = 0;
        let wrongAnswersLog = {};
        let fastestTimes = [];

        // --- Konfiguration ---
        const FLOWER_GOAL = 20;
        const NUM_FLOWERS_PER_LEVEL = 5;
        const NUM_QUESTIONS_PER_ITEM = 5;
        const flowerColors = [ { bg: '#f48fb1', border: '#ad1457' }, { bg: '#90caf9', border: '#1e88e5' }, { bg: '#ffe082', border: '#ffab00' }, { bg: '#a5d6a7', border: '#388e3c' }, { bg: '#b39ddb', border: '#5e35b1' } ];
        const BASE_ENEMY_STEP_SIZE = 10;
        const BASE_ENEMY_MOVE_INTERVAL = 200;
        const ENEMY_RANDOM_FACTOR = 4;
        const ENEMY_FREEZE_DURATION = 10000;
        const ENEMY_SPAWN_DELAY = 5000;
        let currentEnemyStepSize = BASE_ENEMY_STEP_SIZE;
        let currentEnemyMoveInterval = BASE_ENEMY_MOVE_INTERVAL;
        let enemyData = { element: enemyElement, position: { x: -100, y: -100 }, active: false, frozen: false, freezeTimeoutId: null, moveIntervalId: null };

        // --- Initialisierung ---
        function initGame() {
            gameIsOver = false; startTime = Date.now(); wrongAnswersLog = {}; flowersCollected = 0; currentLevel = 1;
            currentEnemyStepSize = BASE_ENEMY_STEP_SIZE; currentEnemyMoveInterval = BASE_ENEMY_MOVE_INTERVAL;
            loadFastestTimes(); updateInventory(); updateTitle(); setupLevel();
            // Event Listener (keep handleFirstClick for audio init)
            gameArea.removeEventListener('click', handleGameAreaClick); // Remove old listener if exists
            gameArea.removeEventListener('click', handleFirstClick); // Remove old listener if exists
            gameArea.addEventListener('click', handleFirstClick);
            hero.addEventListener('transitionend', onHeroMovementEnd);
            numpadContainer.addEventListener('click', handleNumpadClick);
            playAgainButton.addEventListener('click', () => location.reload());
            startEnemyLogic(); endScreen.classList.add('hidden');
        }

        // --- Spezieller Handler für den ersten Klick ---
        function handleFirstClick(event) {
            if (gameIsOver) return; initAudio(); handleGameAreaClick(event);
            gameArea.removeEventListener('click', handleFirstClick);
            gameArea.addEventListener('click', handleGameAreaClick);
        }

        // --- Level Management ---
        function setupLevel() { if(gameIsOver) return; clearOldFlowers(); createFlowers(); }
        function startNewLevel() { /* ... unverändert ... */ if(gameIsOver)return;currentLevel++;updateTitle();playLevelUpJingle();currentEnemyStepSize*=1.20;console.log(`Starte Level ${currentLevel}. Feind Schrittgröße: ${currentEnemyStepSize.toFixed(2)}, Intervall: ${currentEnemyMoveInterval}`);setTimeout(()=>{setupLevel();if(enemyData.active){despawnEnemy();}spawnEnemy();},1500); }
        function updateTitle() { document.title = `Koalas Multiplikations-Abenteuer Lvl. ${currentLevel}`; }

        // --- Blumen Management ---
        function clearOldFlowers() { flowers.forEach(f => { if(f.element&&f.element.parentNode===gameArea){gameArea.removeChild(f.element);} }); flowers = []; }
        function createFlowers() { const aR=gameArea.getBoundingClientRect();const c=flowerColors[(currentLevel-1)%flowerColors.length];for(let i=0;i<NUM_FLOWERS_PER_LEVEL;i++){const f=document.createElement('div');f.classList.add('flower');f.id=`flower-${currentLevel}-${i}`;f.style.backgroundColor=c.bg;f.style.borderColor=c.border;let p,t;let a=0;do{t=false;p=getRandomPosition(aR,60);for(const w of flowers){const d=Math.sqrt(Math.pow(p.x-w.position.x,2)+Math.pow(p.y-w.position.y,2));if(d<50){t=true;break;}}a++;}while(t&&a<100);if(a>=100){console.warn("Konnte keine geeignete Position für Blume finden.");}f.style.left=`${p.x}px`;f.style.top=`${p.y}px`;gameArea.appendChild(f);flowers.push({id:f.id,element:f,collected:false,position:p});}}

        // --- Heldenbewegung & Klick-Handling ---
        function handleGameAreaClick(event) { if(gameIsOver||heroIsMoving||quizModal.style.display==='block'){return;}playClickSound();const aR=gameArea.getBoundingClientRect();const tX=event.clientX-aR.left;const tY=event.clientY-aR.top;moveHero(tX,tY); }
        function moveHero(tX,tY){heroIsMoving=true;const hR=hero.getBoundingClientRect();const hW=hero.offsetWidth||50;const hH=hero.offsetHeight||50;let fX=tX-hW/2;let fY=tY-hH/2;const aR=gameArea.getBoundingClientRect();fX=Math.max(0,Math.min(fX,aR.width-hW));fY=Math.max(0,Math.min(fY,aR.height-hH));hero.style.left=`${fX}px`;hero.style.top=`${fY}px`;}
        function onHeroMovementEnd() { if (gameIsOver) return; heroIsMoving = false; checkCollision(); }

        // --- Kollisionserkennung ---
        function checkCollision() { if(gameIsOver)return;if(enemyData.active&&!enemyData.frozen&&quizModal.style.display!=='block'){const hR=hero.getBoundingClientRect();const eR=enemyData.element.getBoundingClientRect();if(checkRectOverlap(hR,eR)){playEnemyHitSound();triggerEnemyQuiz();return;}}if(heroIsMoving||quizModal.style.display==='block')return;const hR=hero.getBoundingClientRect();for(let f of flowers){if(!f.collected){const fR=f.element.getBoundingClientRect();if(checkRectOverlap(hR,fR)){playInteractSound();activeItem=f;activeItemType='flower';startQuiz();return;}}}}
        function checkRectOverlap(r1,r2){return!(r1.right<r2.left||r1.left>r2.right||r1.bottom<r2.top||r1.top>r2.bottom);}

        // --- NumPad-Logik ---
        function handleNumpadClick(event) { if(gameIsOver)return;const t=event.target;if(t.tagName!=='BUTTON')return;playClickSound();if(t.hasAttribute('data-digit')){const d=t.getAttribute('data-digit');if(quizInputDisplay.textContent.length<4){quizInputDisplay.textContent+=d;}}else if(t.id==='numpad-clear'){quizInputDisplay.textContent='';}else if(t.id==='numpad-submit'){checkAnswer();}}

        // --- Quiz-Logik ---
        function startQuiz() { if(gameIsOver||!activeItem)return;quizTitle.textContent="Blumen-Aufgabe!";currentQuestions=generateQuestions(NUM_QUESTIONS_PER_ITEM);currentQuestionIndex=0;quizMessage.textContent='';quizMessage.className='';quizInputDisplay.textContent='';displayQuestion();quizModal.style.display='block';}
        function triggerEnemyQuiz() { if(gameIsOver||!enemyData.active||enemyData.frozen)return;if(enemyData.moveIntervalId){clearInterval(enemyData.moveIntervalId);enemyData.moveIntervalId=null;}activeItem=enemyData;activeItemType='enemy';quizTitle.textContent="Monster-Aufgabe!";currentQuestions=generateQuestions(NUM_QUESTIONS_PER_ITEM);currentQuestionIndex=0;quizMessage.textContent='';quizMessage.className='';quizInputDisplay.textContent='';displayQuestion();quizModal.style.display='block';}
        function generateQuestions(count) { const qs=[];for(let i=0;i<count;i++){const n1=Math.floor(Math.random()*10)+1;const n2=Math.floor(Math.random()*10)+1;qs.push({text:`${n1} x ${n2} = ?`,answer:n1*n2,num1:n1,num2:n2});}return qs;}
        function displayQuestion() { if(currentQuestionIndex<currentQuestions.length){quizQuestion.textContent=currentQuestions[currentQuestionIndex].text;}else{console.error("Versucht, Frage außerhalb des Bereichs anzuzeigen.");}}

        function checkAnswer() {
            if (gameIsOver) return;
            const userAnswerText = quizInputDisplay.textContent;
            if(userAnswerText===''){quizMessage.textContent="Bitte gib eine Antwort über die Tasten ein!";quizMessage.className='incorrect';return;}
            const userAnswer=parseInt(userAnswerText,10);
            const currentQ=currentQuestions[currentQuestionIndex];
            const correctAnswer=currentQ.answer;
            if(isNaN(userAnswer)){quizMessage.textContent="Ungültige Eingabe.";quizMessage.className='incorrect';quizInputDisplay.textContent='';return;}

            if (userAnswer === correctAnswer) {
                playCorrectSound(); quizMessage.textContent="Richtig!"; quizMessage.className='correct'; currentQuestionIndex++;
                setTimeout(() => { if(currentQuestionIndex>=currentQuestions.length){handleQuizSuccess();}else{quizMessage.textContent='';quizMessage.className='';quizInputDisplay.textContent='';displayQuestion();}}, 800);
            } else {
                playWrongSound(); logWrongAnswer(currentQ.num1, currentQ.num2);
                quizMessage.textContent=`Leider falsch. Die richtige Antwort war ${correctAnswer}. Versuche die Frage erneut!`;
                quizMessage.className='incorrect'; quizInputDisplay.textContent='';
            }
        }

        // --- **** MODIFIED handleQuizSuccess **** ---
        function handleQuizSuccess() {
            if (gameIsOver) return;
            quizModal.style.display = 'none'; // Quiz immer schließen

            const itemJustProcessed = activeItem; // Kopiere die Referenz, bevor sie unten genullt wird
            const itemTypeProcessed = activeItemType;

             // DEBUGGING: Log what item is being processed
            console.log("handleQuizSuccess triggered for:", itemTypeProcessed, itemJustProcessed);

            if (itemTypeProcessed === 'flower') {
                 // WICHTIG: Prüfen ob das Item noch gültig ist
                 if (itemJustProcessed && itemJustProcessed.element && !itemJustProcessed.collected) {
                    console.log("Processing valid flower:", itemJustProcessed.id);
                    playCollectSound();
                    itemJustProcessed.element.classList.add('hidden'); // Hide the flower
                    itemJustProcessed.collected = true;              // Mark as collected in data
                    flowersCollected++;
                    updateInventory();

                    // Check for game end or level change
                    if (flowersCollected >= FLOWER_GOAL) {
                        endGame(); // End the game if goal reached
                    } else if (flowers.every(f => f.collected)) { // Check if all flowers OF CURRENT LEVEL are collected
                         setTimeout(() => {
                            alert(`Super! Level ${currentLevel} geschafft! ${flowersCollected} von ${FLOWER_GOAL} Blumen insgesamt gesammelt.`);
                            startNewLevel();
                        }, 300); // Delay after sound
                    }
                } else {
                     console.warn("Skipping flower processing in handleQuizSuccess - item invalid or already collected:", itemJustProcessed);
                 }

            } else if (itemTypeProcessed === 'enemy') {
                console.log("Processing enemy freeze");
                playFreezeSound();
                freezeEnemy();
            } else {
                 console.warn("handleQuizSuccess called with unknown item type:", itemTypeProcessed);
            }

            // Reset active item AFTER processing
            activeItem = null;
            activeItemType = null;

             // Check if enemy movement needs restarting AFTER quiz modal is closed and processing is done
             if (itemTypeProcessed === 'enemy' && !enemyData.frozen && quizModal.style.display !== 'block') {
                console.log("Restarting enemy movement after enemy quiz success (not frozen)");
                 if (enemyData.moveIntervalId) clearInterval(enemyData.moveIntervalId);
                 enemyData.moveIntervalId = setInterval(moveEnemy, currentEnemyMoveInterval);
             }
        }
        // --- **** END MODIFIED handleQuizSuccess **** ---


        // --- Inventar aktualisieren ---
        function updateInventory() { inventoryDisplay.textContent = `Blumen: ${flowersCollected} / ${FLOWER_GOAL}`; }

        // --- Feind-Logik ---
        function startEnemyLogic() { if(gameIsOver)return;setTimeout(spawnEnemy,ENEMY_SPAWN_DELAY); }
        function spawnEnemy() { if(gameIsOver||enemyData.active)return;playEnemySpawnSound();const aR=gameArea.getBoundingClientRect();const e=Math.floor(Math.random()*4);const s=40;let sX,sY;switch(e){case 0:sX=Math.random()*(aR.width-s);sY=-s;break;case 1:sX=aR.width;sY=Math.random()*(aR.height-s);break;case 2:sX=Math.random()*(aR.width-s);sY=aR.height;break;case 3:sX=-s;sY=Math.random()*(aR.height-s);break;}enemyData.position={x:sX,y:sY};enemyData.element.style.left=`${sX}px`;enemyData.element.style.top=`${sY}px`;enemyData.element.classList.remove('hidden','enemy-frozen');enemyData.active=true;enemyData.frozen=false;if(enemyData.moveIntervalId)clearInterval(enemyData.moveIntervalId);enemyData.moveIntervalId=setInterval(moveEnemy,currentEnemyMoveInterval);console.log(`Feind gespawnt (Level ${currentLevel})`); }
        function despawnEnemy() { if(!enemyData.active)return;if(enemyData.moveIntervalId)clearInterval(enemyData.moveIntervalId);if(enemyData.freezeTimeoutId)clearTimeout(enemyData.freezeTimeoutId);enemyData.element.classList.add('hidden');enemyData.active=false;enemyData.frozen=false;enemyData.moveIntervalId=null;enemyData.freezeTimeoutId=null;enemyData.position={x:-100,y:-100};console.log("Feind despawned"); }
        function moveEnemy() { if(gameIsOver||quizModal.style.display==='block'||!enemyData.active||enemyData.frozen){return;}const eX=enemyData.position.x;const eY=enemyData.position.y;const hR=hero.getBoundingClientRect();const aR=gameArea.getBoundingClientRect();const hCX=(hR.left-aR.left)+hR.width/2;const hCY=(hR.top-aR.top)+hR.height/2;const dX=hCX-(eX+enemyData.element.offsetWidth/2);const dY=hCY-(eY+enemyData.element.offsetHeight/2);const dist=Math.sqrt(dX*dX+dY*dY);if(dist<5){checkCollision();return;}const nX=dX/dist;const nY=dY/dist;let sX=nX*currentEnemyStepSize;let sY=nY*currentEnemyStepSize;sX+=(Math.random()-0.5)*2*ENEMY_RANDOM_FACTOR;sY+=(Math.random()-0.5)*2*ENEMY_RANDOM_FACTOR;let nXp=eX+sX;let nYp=eY+sY;const eW=enemyData.element.offsetWidth||40;const eH=enemyData.element.offsetHeight||40;nXp=Math.max(0,Math.min(nXp,aR.width-eW));nYp=Math.max(0,Math.min(nYp,aR.height-eH));enemyData.position={x:nXp,y:nYp};enemyData.element.style.left=`${nXp}px`;enemyData.element.style.top=`${nYp}px`;checkCollision(); }
        function freezeEnemy() { if(gameIsOver||!enemyData.active)return;if(enemyData.moveIntervalId){clearInterval(enemyData.moveIntervalId);enemyData.moveIntervalId=null;}if(enemyData.freezeTimeoutId){clearTimeout(enemyData.freezeTimeoutId);}enemyData.frozen=true;enemyData.element.classList.add('enemy-frozen');enemyData.freezeTimeoutId=setTimeout(unfreezeEnemy,ENEMY_FREEZE_DURATION); }
        function unfreezeEnemy() { if(gameIsOver||!enemyData.active||!enemyData.frozen)return;playUnfreezeSound();enemyData.frozen=false;enemyData.element.classList.remove('enemy-frozen');enemyData.freezeTimeoutId=null;if(quizModal.style.display!=='block'){if(enemyData.moveIntervalId)clearInterval(enemyData.moveIntervalId);enemyData.moveIntervalId=setInterval(moveEnemy,currentEnemyMoveInterval);}}

        // --- Zeit- und Speicherfunktionen ---
        function formatTime(ms){if(typeof ms!=='number'||isNaN(ms))return 'Ungültig';const s=Math.floor(ms/1000);const m=Math.floor(s/60);const sec=s%60;const mil=Math.floor(ms%1000);return `${String(m).padStart(2,'0')}:${String(sec).padStart(2,'0')}.${String(mil).padStart(3,'0')}`; }
        function loadFastestTimes(){try{const s=localStorage.getItem('koalaMultiplyFastestTimes');if(s){fastestTimes=JSON.parse(s);if(!Array.isArray(fastestTimes))fastestTimes=[];fastestTimes=fastestTimes.filter(t=>typeof t==='number'&&!isNaN(t));}else{fastestTimes=[];}}catch(e){console.error("Konnte Bestzeiten nicht laden:",e);fastestTimes=[];}fastestTimes.sort((a,b)=>a-b);}
        function saveFastestTimes(){try{localStorage.setItem('koalaMultiplyFastestTimes',JSON.stringify(fastestTimes));}catch(e){console.error("Konnte Bestzeiten nicht speichern:",e);}}
        function updateFastestTimes(t){if(typeof t!=='number'||isNaN(t))return;fastestTimes.push(t);fastestTimes.sort((a,b)=>a-b);fastestTimes=fastestTimes.slice(0,5);saveFastestTimes();}
        function logWrongAnswer(n1,n2){const k=`${Math.min(n1,n2)}x${Math.max(n1,n2)}`;wrongAnswersLog[k]=(wrongAnswersLog[k]||0)+1;}
        function formatWrongAnswersForDisplay(){const f=[];const k=Object.keys(wrongAnswersLog);if(k.length===0){return["<li>Keine Fehler gemacht!</li>"];}k.sort();for(const key of k){const c=wrongAnswersLog[key];f.push(`<li>${c}x falsch: ${key.replace('x',' x ')}</li>`);}return f;}

        // --- Spielende Funktion ---
        function endGame() {
            if(gameIsOver)return;gameIsOver=true;console.log("Spiel beendet!");playGameOverSound();const eT=Date.now()-startTime;despawnEnemy();gameArea.removeEventListener('click',handleGameAreaClick);gameArea.removeEventListener('click',handleFirstClick);quizModal.style.display='none';updateFastestTimes(eT);finalTimeDisplay.textContent=`Deine Zeit: ${formatTime(eT)}`;fastestTimesList.innerHTML='';if(fastestTimes.length>0){fastestTimes.forEach((t,i)=>{const l=document.createElement('li');l.textContent=`${i+1}. ${formatTime(t)}`;fastestTimesList.appendChild(l);});for(let i=fastestTimes.length;i<5;i++){const l=document.createElement('li');l.textContent=`${i+1}. -`;fastestTimesList.appendChild(l);}}else{fastestTimesList.innerHTML='<li>Noch keine Zeiten gespeichert.</li>';}const wA=formatWrongAnswersForDisplay();wrongAnswersList.innerHTML=wA.join('');endScreen.classList.remove('hidden');
        }

        // Hilfsfunktion für zufällige Position
        function getRandomPosition(bounds,margin){const w=bounds.width||window.innerWidth;const h=bounds.height||window.innerHeight;const s=40;const x=Math.random()*(w-margin*2-s)+margin;const y=Math.random()*(h-margin*2-s)+margin;return {x,y};}

        // --- Spielstart ---
        document.addEventListener('DOMContentLoaded', initGame);

    </script>
</body>
</html>
